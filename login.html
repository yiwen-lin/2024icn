<!-- Header Link -->
<!DOCTYPE html>
<html lang="en" data-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Login | ICN Merger Workshop</title>
    <link rel="icon" href="assets/img/faveicon.png" type="image/gif" sizes="16x16">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
    <link rel="stylesheet" href="assets/css/plugin.css">
    <link rel="stylesheet" href="assets/css/components.css">
    <link rel="stylesheet" href="assets/css/style.css">
</head>
<body>
  

<!-- Header Section -->
<!-- Header Start Here -->
<header class="header-area header-general">
    <div class="container">
        <div class="header-wrapper header-general-wrapper">
            <div class="logo">
                <a href="index.html">
                    <img src="assets/img/logo/logo.png" alt="logo">
                </a>
            </div>
            <div class="header-wrap ">
                <!-- Menu Start -->
                <div class="main-menu ">
                    <ul>
                        <li><a href="index.html">Home</a></li>
                        <li><a href="agenda.html">Agenda</a></li>
                        <li><a href="accommodation.html">Accommodation</a></li>
                        <li><a href="events.html">Social Events</a></li>
                        <!-- <li><a href="gallery.html">Gallery</a></li>
                        <li><a href="session.html">Session</a></li> -->
                        <li><a href="faq.html">FAQ</a></li>
                        <li><a href="register.html">Register</a></li>
                        <li><a href="login.html"><i class="icofont-user-alt-6"></i></a></li>
                    </ul>
                </div>
                <!-- Menu Start -->
                <div class="header-right">
                    <div class="book-ticket header-account">
                        <a class="btn btn-lg-space btn-bg-g-secondary" href="register.html">Register</a>
                    </div>
                    <div class="hamburger">
                        <div class="plates">
                            <!--  onclick="this.classList.toggle('active')" -->
                            <div class="plate plate5">
                              <svg class="burger" version="1.1" height="100" width="100" viewBox="0 0 100 100">
                                <path class="line line1" d="M 30,35 H 70 " />
                                <path class="line line2" d="M 50,50 H 30 L 34,32" />
                                <path class="line line3" d="M 50,50 H 70 L 66,68" />
                                <path class="line line4" d="M 30,65 H 70 " />
                              </svg>
                              <svg class="x" version="1.1" height="100" width="100" viewBox="0 0 100 100">
                                <path class="line" d="M 34,32 L 66,68" />
                                <path class="line" d="M 66,32 L 34,68" />
                              </svg>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</header>
<!-- Header End Here -->

<section class="login-area">
    <div class="container-fluid">
        <div class="login-wrapper">
            <div class="login-thumb">
                <img src="assets/img/thumb/login-thumb.png" alt="login">
            </div>
            <form method="post" id="login" class="login-form">
                <div class="from-title">
                    <h1 data-aos="fade-up" data-aos-delay="10">Welcome Back!</h1>
                    <h6 data-aos="fade-up" data-aos-delay="100">Sign into your account for full access & Enjoy Event</h6>
                </div>
                <div class="login-input">
                    <div class="single-form mb-20" data-aos="fade-up" data-aos-delay="200">
                        <label>Your Email</label>
                        <div class="from-box">
                            <input type="email" placeholder="Enter your email address" class="form-control" name="email">
                            <i class="icofont-ui-message"></i>
                        </div>
                    </div>
                    <div class="single-form mb-20" data-aos="fade-up" data-aos-delay="400">
                        <label>Password</label>
                        <div class="from-box">
                            <input type="password" placeholder="* * * * * * * *" class="form-control" name="password">
                            <i class="icofont-lock"></i>
                        </div>
                    </div>

                    <button class="btn btn-lg-space" data-aos="fade-up" data-aos-delay="500" type="submit">Login <i class="icofont-long-arrow-right"></i></button>
                </div>
                <div class="login-footer" data-aos="fade-up" data-aos-delay="600">
                    <!-- 新增popup btn-->
                    <p><a href="#0" class="cd-popup-trigger">Forget the password?</a></p> 
                </div>
            </form>         

            
        </div>
    </div>
</section>

<!-- 新增popup start -->
<div class="cd-popup" role="alert">
	<div class="cd-popup-container">
        <form method="post" id="forgot-password" class="login-form-popup">
            <div class="from-title">
                <h5 data-aos="fade-up" data-aos-delay="10" class="mb-30">Forget the password？</h5>
            </div>
            <div class="login-input">
                <div class="single-form mb-30" data-aos="fade-up" data-aos-delay="200">
                    <label>Your Email</label>
                    <div class="from-box">
                        <input type="email" placeholder="Enter your email address" class="form-control" name="email">
                        <i class="icofont-ui-message"></i>
                    </div>
                </div>
                <button class="btn btn-lg-space" data-aos="fade-up" data-aos-delay="500" type="submit">Get the password</button>
            </div>
        </form>
		<a href="#0" class="cd-popup-close img-replace">Close</a>
	</div>
</div>
<!-- 新增popup end-->

<!-- Footer Area Start Here -->
<footer class="primary-footer-area py-70 py-md-40 bg-dark secondary-footer">
    <div class="container">
           <div class="footer-items">
            <div class="footer-contact">
                <h4 class="footer-title">Contact Us</h4>
                <a href="mailto:info.2024icn.merger@ftc.gov.tw"><i class="icofont-ui-message"></i>info.2024icn.merger@ftc.gov.tw</a>
            </div>
           </div>
    </div>
</footer>
<!-- Footer Area End Here -->
<!-- Copy Right Start Here -->
<div class="copyright">
    <p>Copyright © 2024 FAIR TRADE COMMISSION. All rights reserved.​</p>
</div>
<!-- Copy Right End Here --><!-- Footer Area End Here -->
<!-- Footer script-->
<!-- Jquery call here-->
<script src="assets/js/app.min.js"></script>
<!-- custom script call here -->
<script src="assets/js/scripts.js"></script>
</body>
<script>
    const LOGIN_API_URL = `https://epass.icn2024merger.tw/api/query`;
    const FORGOT_PASSWORD_API_URL = `https://epass.icn2024merger.tw/api/forgot-password`;
    const BEARER_TOKEN = 'KU3mDVHXaLiVt2kjfGT0k69OoJf3CWH9z3zbugzlbcc0e25b';
    const EDITOR_URL = 'register-b.html';

    document.getElementById('login').addEventListener('submit', function (e) {
        e.preventDefault();

        const form = e.target;

        let checkValid = validateInputs(form);

        if (checkValid) {
            const formData = new FormData(form);
            let password = '';

            const data = {};

            formData.forEach((value, key) => {
                if (key === 'password') {
                    password = value;
                }
                data[key] = value;
            });

            fetch(LOGIN_API_URL, {
                method: 'POST',
                headers: {
                    'Accept': 'application/json',
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${BEARER_TOKEN}`
                },
                body: JSON.stringify(data)
            }).then((response) => {
                if (response.ok === true) {
                    return response.json();
                } else if (response.status === 422) {
                    return response.json().then(errorData => {
                        let errorMessages = [];
                        for (const [field, errors] of Object.entries(errorData.errors)) {
                            errors.forEach(error => {
                                errorMessages.push(errors);
                                form.querySelector(`[name="${field}"]`).parentNode.classList.add("error");
                                console.error(`${field}: ${error}`);
                            });
                        }

                        alert(errorMessages.join('\n'));

                        focusValidateInput(form);

                        throw new Error('Validation failed');
                    });
                } else if (response.status === 404) {
                    return response.json().then(response => {
                        form.querySelector(`[name="email"]`).parentNode.classList.add("error");
                        form.querySelector(`[name="password"]`).parentNode.classList.add("error");
                        alert(response.message);

                        throw new Error(response.message);
                    });
                } else if (response.status === 401) {
                    return response.json().then(response => {
                        form.querySelector(`[name="password"]`).parentNode.classList.add("error");

                        alert(response.message);

                        throw new Error(response.message);
                    });
                } else {
                    return response.text().then(text => {
                        throw new Error(response.statusText + ": " + text);
                    });
                }
            }).then((responseData) => {
                responseData.data['password'] = password;
                responseData.data['confirm_password'] = password;
                localStorage.setItem("registerData", JSON.stringify(responseData.data));
                window.location.href = EDITOR_URL;
                console.log('Success');
            }).catch(error => {
                console.error('Fetch error:', error);
            }).finally(() => {
            });
        } else {
            alert('You have required fields that are not filled out. Please complete them before submitting.')
        }
    });

    document.getElementById('forgot-password').addEventListener('submit', function (e) {
        e.preventDefault();

        const form = e.target;

        let checkValid = validateInputs(form);

        if (checkValid) {
            const formData = new FormData(form);
            let password = '';

            const data = {};

            formData.forEach((value, key) => {
                data[key] = value;
            });

            fetch(FORGOT_PASSWORD_API_URL, {
                method: 'POST',
                headers: {
                    'Accept': 'application/json',
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${BEARER_TOKEN}`
                },
                body: JSON.stringify(data)
            }).then((response) => {
                if (response.ok === true) {
                    return response.json();
                } else if (response.status === 422) {
                    return response.json().then(errorData => {
                        let errorMessages = [];
                        for (const [field, errors] of Object.entries(errorData.errors)) {
                            errors.forEach(error => {
                                errorMessages.push(errors);
                                form.querySelector(`[name="${field}"]`).parentNode.classList.add("error");
                                console.error(`${field}: ${error}`);
                            });
                        }

                        alert(errorMessages.join('\n'));

                        focusValidateInput(form);

                        throw new Error('Validation failed');
                    });
                } else if (response.status === 404) {
                    return response.json().then(response => {
                        form.querySelector(`[name="email"]`).parentNode.classList.add("error");
                        alert(response.message);

                        throw new Error(response.message);
                    });
                } else {
                    return response.text().then(text => {
                        throw new Error(response.statusText + ": " + text);
                    });
                }
            }).then((responseData) => {
                alert(responseData.message);
                console.log('Success', responseData);
            }).catch(error => {
                console.error('Fetch error:', error);
            }).finally(() => {
            });
        } else {
            alert('You have required fields that are not filled out. Please complete them before submitting.')
        }
    });

    function validateInputs(targetForm) {
        var inputs = targetForm.querySelectorAll('.form-control');
        var valid = [];
        var radioCheck = false;
        var checkboxCheck = false;
        inputs.forEach(function (i, j) {
            var checkAttr = i.tagName;
            if(i.getAttribute('type')){
                checkAttr = i.getAttribute('type');
            }

            switch(checkAttr){
                case 'text':
                    var _thisVal = i.value;
                    if (_thisVal === '') {
                        i.parentNode.classList.add("error");
                        valid.push(i.getAttribute('name'));
                    }else{
                        i.parentNode.classList.remove("error");
                    }
                    break;
                case 'select':
                    if (i[select.selectedIndex].value === '') {
                        i.parentNode.classList.add("error");
                        valid.push(i.getAttribute('name'));
                    } else {
                        i.parentNode.classList.remove("error");
                    }
                    break;
                default:
                    if (i.value === '') {
                        i.parentNode.classList.add("error");
                        valid.push(i.getAttribute('name'));
                    } else {
                        i.parentNode.classList.remove("error");
                    }
                    break;
            }
        });

        if (valid.length > 0) {
            focusValidateInput(targetForm);

            return false;
        } else {
            return true;
        }
    }

    function focusValidateInput(targetForm) {
        const targetTop = targetForm.querySelector(`.error`).parentNode.offsetTop;
        const header = document.querySelector(`header`).offsetHeight;
        const scrollTop = targetTop - header - 200;
        window.scrollTo({
            top: scrollTop > 0 ? scrollTop : 0,
            behavior: "smooth",
        });
    }
</script>
</html>